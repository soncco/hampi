{% extends 'base.html' %}
{% block content %}
<div class="page-header">
  <h3><i class="fa fa-file icon-new"></i> Registrar Venta
    <span class="small pull-right">
      <a class="btn btn-success btn-sm" href="{% url 'ventas' %}"><i class="fa fa-table"></i> Ver todas las ventas</a>
    </span>
  </h3>
</div>
<form action="{% url 'venta' %}" role="form" method="post" id="the-form">
<div class="row">
  <div class="col-md-3">
    <div class="page-header mini">
      <h5>Información</h5>
    </div>
    <div class="form-group">
      <label for="almacen">Almacén:</label>
      <select name="almacen" id="almacen" class="form-control" required>
        {% for almacen in almacenes %}
        <option value="{{ almacen.pk }}">{{ almacen.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <input type="text" class="form-control autocomplete-clientes" id="cliente" required autocomplete="off" placeholder="Cliente/Destinatario *" data-toggle="tooltip" data-placement="bottom" title="Cliente/Destinatario *">
      <input type="hidden" id="cliente-id" name="cliente">
    </div>
    <div class="form-group">
      <select name="tipo_venta" id="tipo_venta" class="form-control" required>
        <option value="">Tipo de Venta</option>
        <option value="P">Crédito</option>
        <option value="C">Contado</option>
      </select>
    </div>
    <div class="form-group" style="display:none">
      <input type="number" class="form-control" id="monto" name="monto" step="any" min="0" placeholder="Adelanto inicial" data-toggle="tooltip" data-placement="bottom" title="Adelanto Inicial">
    </div>
    <div class="page-header mini">
      <h5>Datos de la factura</h5>
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="numero_factura" id="numero_factura" required autocomplete="off" placeholder="Número Factura *" data-toggle="tooltip" data-placement="bottom" title="Número Factura *">
    </div>
    <div class="form-group">
      <input type="text" class="form-control datepicker-start" name="fecha_factura" id="fecha_factura" required autocomplete="off" placeholder="Fecha Factura *"data-toggle="tooltip" data-placement="bottom" title="Fecha Factura *">
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="orden_compra" id="orden_compra" placeholder="Orden de Compra" data-toggle="tooltip" data-placement="bottom" title="Orden de Compra">
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="condiciones" id="condiciones" placeholder="Condiciones" data-toggle="tooltip" data-placement="bottom" title="Condiciones">
    </div>
    <div class="form-group">
      <input type="text" class="form-control datepicker datepicker-end" name="vencimiento" id="vencimiento" placeholder="Fecha de Vencimiento" data-toggle="tooltip" data-placement="bottom" title="Fecha de Vencimiento">
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="zona" id="zona" placeholder="Zona" data-toggle="tooltip" data-placement="bottom" title="Zona">
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="hora" id="hora" placeholder="Hora" data-toggle="tooltip" data-placement="bottom" title="Hora">
    </div>
    
  </div>

  <div class="col-md-3 line-left">
    <div class="page-header mini">
      <h5>Datos de la guía</h5>
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="numero_guia" id="numero_guia" placeholder="Número de Guía *" required data-toggle="tooltip" data-placement="bottom" title="Número de Guía">
    </div>
    <div class="form-group">
      <input type="text" class="form-control datepicker" name="fecha_emision" id="fecha_emision" required autocomplete="off" placeholder="Fecha Emisión *" data-toggle="tooltip" data-placement="bottom" title="Fecha Emisión *">
    </div>
    <div class="form-group">
      <input type="text" class="form-control datepicker" name="fecha_traslado" id="fecha_traslado" required autocomplete="off" placeholder="Fecha Traslado *" data-toggle="tooltip" data-placement="bottom" title="Fecha Traslado *">
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="procedencia" id="procedencia" placeholder="Procedencia *" data-toggle="tooltip" data-placement="bottom" title="Procedencia *" value="Calle Clorinda Matto" required>
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="llegada" id="llegada" placeholder="Llegada *" data-toggle="tooltip" data-placement="bottom" title="Llegada *" required>
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="vehiculo" id="vehiculo" placeholder="Datos de Vehículo" data-toggle="tooltip" data-placement="bottom" title="Datos de Vehículo">
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="inscripcion" id="inscripcion" placeholder="Inscripción" data-toggle="tooltip" data-placement="bottom" title="Inscripción">
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="licencia" id="licencia" placeholder="Licencia" data-toggle="tooltip" data-placement="bottom" title="Licencia">
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="costo" id="costo" placeholder="Costo de Transporte" data-toggle="tooltip" data-placement="bottom" title="Costo de Transporte">
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="transportista" id="transportista" placeholder="Transportista" data-toggle="tooltip" data-placement="bottom" title="Transportista">
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="ruc_transportista" id="ruc_transportista" placeholder="RUC Transportista" data-toggle="tooltip" data-placement="bottom" title="RUC Transportista" maxlength="11">
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="bultos" id="bultos" placeholder="Nro Bultos" data-toggle="tooltip" data-placement="bottom" title="Nro Bultos">
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="despachador" id="despachador" placeholder="Despachador" data-toggle="tooltip" data-placement="bottom" title="Despachador">
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="jefe_almacen" id="jefe_almacen" placeholder="Jefe Almacén" data-toggle="tooltip" data-placement="bottom" title="Jefe Almacén">
    </div>
    <div class="form-group">
      <input type="text" class="form-control" name="vb" id="vb" placeholder="VB" data-toggle="tooltip" data-placement="bottom" title="VB">
    </div>
  </div>

  <div class="col-md-6 line-left">
    <div class="page-header mini">
      <h5>Detalles</h5>
    </div>
    <table class="table table-striped table-condensed">
      <thead>
        <tr>
          <th class="col-md-2">Cantidad</th>
          <th>Producto</th>
          <th class="col-md-2">Unitario</th>
          <th class="col-md-2">Total</th>
        </tr>
      </thead>
      <tbody id="detalles">
        <tr>
          <td>
            <input type="number" class="form-control input-sm input-xs cantidad" min="1" step="any">
          </td>
          <td>
            <input type="text" class="form-control input-sm input-xs autocomplete-productos">
          </td>
          <td>
            <input type="number" class="form-control input-sm input-xs iunitario" min="0.000001" step="0.000001">
          </td>
          <td>
            <input type="number" class="form-control input-sm input-xs itotal" min="0.000001" step="0.000001">
          </td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="4">
            <button class="btn btn-info btn-block btn-sm" type="button" id="add-detalle"><i class="fa fa-plus-circle"></i> Agregar</button>
          </td>
        </tr>
      </tfoot>
    </table>
    <div class="page-header mini">
      <h5>Detalles Agregados</h5>
    </div>
    <table class="table table-striped table-condensed table-bordered small">
      <tfoot>
        <tr>
          <td colspan="5" class="text-right">Venta Total:</td>
          <td colspan="2" class="text-right">
            <input type="number" class="form-control input-sm" id="total_venta" name="total_venta" readonly value="0.0">
          </td>
        </tr>
      </tfoot>
      <thead>
        <tr>
          <th>Lote</th>
          <th>Vencimiento</th>
          <th>Producto</th>
          <th>Cantidad</th>
          <th>Unitario</th>
          <th>Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody class="detalles">
      </tbody>
    </table>
  </div>
</div>  
<div class="actions">
  <p class="text-center">
    <button class="btn btn-success btn-block btn-lg"><i class="fa fa-floppy-o"></i> Guardar</button>
    {% csrf_token %}
  </p>
</div>
<input id="id_{{ detalle_form.prefix }}-TOTAL_FORMS" name="{{ detalle_form.prefix }}-TOTAL_FORMS" type="hidden" value="">
<input id="id_{{ detalle_form.prefix }}-INITIAL_FORMS" name="{{ detalle_form.prefix }}-INITIAL_FORMS" type="hidden" value="0">
<input id="id_{{ detalle_form.prefix }}-MAX_NUM_FORMS" name="{{ detalle_form.prefix }}-MAX_NUM_FORMS" type="hidden" value="1000">
<input type="hidden" id="vendedor" name="vendedor" value="{{user.id}}">
<input type="hidden" id="fecha" name="fecha" value="{% now 'Y-m-d' %}">
<input type="hidden" id="venta" name="venta" value="">
</form>
<input type="hidden" id="producto-id" name="producto-id">
<input type="hidden" id="unitario" name="unitario">
<input type="hidden" id="vencimiento" name="vencimiento">
<input type="hidden" id="numero" name="numero">
{% endblock %}

{% block js %}
<script>
  var prefix = '{{ detalle_form.prefix }}';
</script>
<script src="/media/bower_components/handlebars/handlebars.min.js"></script>
<script src="/media/bower_components/underscore/underscore.js"></script>
<script src="/media/bower_components/backbone/backbone.js"></script>
<script src="/media/js/models/ventadetalle.js"></script>
<script src="/media/js/collections/ventadetalles.js"></script>
<script src="/media/js/main.js"></script>
<script src="/media/js/ventas.js"></script>
{% endblock %}

{% block title %}Registrar Venta{% endblock %}

{% block templates %}
<script type="text/x-handlebars-template" id="tpl-detalle-row">
  <tr class="animated bounceInDown" data-row="{% templatetag openvariable %}row{% templatetag closevariable %}">
    <td>{% templatetag openvariable %}numero{% templatetag closevariable %}</td>
    <td>{% templatetag openvariable %}vencimiento{% templatetag closevariable %}</td>
    <td>{% templatetag openvariable %}producto{% templatetag closevariable %}</td>
    <td class="text-right">{% templatetag openvariable %}cantidad{% templatetag closevariable %}</td>
    <td class="text-right">{% templatetag openvariable %}unitario{% templatetag closevariable %}</td>
    <td class="text-right total">{% templatetag openvariable %}total{% templatetag closevariable %}</td>
    <td>
      <button class="btn btn-danger btn-sm remove-detalle" type="button"><i class="fa fa-times"></i></button>
    </td>
  </tr>
</script>
<script type="text/x-handlebars-template" id="tpl-hidden">
  <input type="hidden" name="{% templatetag openvariable %} name {% templatetag closevariable %}" value="{% templatetag openvariable %} value {% templatetag closevariable %}">
</script>
{% endblock %}
